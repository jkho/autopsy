/*
 * Autopsy Forensic Browser
 *
 * Copyright 2011-2019 Basis Technology Corp.
 * Contact: carrier <at> sleuthkit <dot> org
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package org.sleuthkit.autopsy.configurelogicalimager;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import javax.swing.JButton;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JTable;
import javax.swing.table.AbstractTableModel;
import org.apache.commons.lang3.tuple.ImmutablePair;
import org.openide.util.NbBundle;

/**
 * Configuration Visual Panel 2
 */
@NbBundle.Messages({
    "ConfigVisualPanel2.ok=OK",
    "ConfigVisualPanel2.cancel=Cancel"
})
public final class ConfigVisualPanel2 extends JPanel {

    private static final List<String> EMPTY_LIST = new ArrayList<>();
    private String configFilename;
    private LogicalImagerConfig config = null;
    private final JButton okButton = new JButton(Bundle.ConfigVisualPanel2_ok());
    private final JButton cancelButton = new JButton(Bundle.ConfigVisualPanel2_cancel());
    private boolean flagEncryptionPrograms = false;
    
    /**
     * Creates new form ConfigVisualPanel2
     */
    public ConfigVisualPanel2() {
        initComponents();
        if (config != null) {
            updatePanel(configFilename, config);
        }
    }

    @NbBundle.Messages({
        "ConfigVisualPanel2.editConfiguration=Edit configuration"
    })
    @Override
    public String getName() {
        return Bundle.ConfigVisualPanel2_editConfiguration();
    }

    public boolean isFlagEncryptionPrograms() {
        return flagEncryptionPrograms;
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        modifiedDateLabel = new javax.swing.JLabel();
        daysIncludedTextField = new javax.swing.JTextField();
        daysIncludedLabel = new javax.swing.JLabel();
        fullPathsLabel = new javax.swing.JLabel();
        flagEncryptionProgramsCheckBox = new javax.swing.JCheckBox();
        ruleNameLabel = new javax.swing.JLabel();
        ruleNameEditTextField = new javax.swing.JTextField();
        newRuleButton = new javax.swing.JButton();
        descriptionLabel = new javax.swing.JLabel();
        editRuleButton = new javax.swing.JButton();
        descriptionEditTextField = new javax.swing.JTextField();
        deleteRuleButton = new javax.swing.JButton();
        jScrollPane5 = new javax.swing.JScrollPane();
        fullPathsTable = new javax.swing.JTable();
        jScrollPane6 = new javax.swing.JScrollPane();
        filenamesTable = new javax.swing.JTable();
        shouldSaveCheckBox = new javax.swing.JCheckBox();
        shouldAlertCheckBox = new javax.swing.JCheckBox();
        jScrollPane7 = new javax.swing.JScrollPane();
        folderNamesTable = new javax.swing.JTable();
        extensionsLabel = new javax.swing.JLabel();
        extensionsTextField = new javax.swing.JTextField();
        filenamesLabel = new javax.swing.JLabel();
        configFileTextField = new javax.swing.JTextField();
        ruleSetFileLabel = new javax.swing.JLabel();
        finalizeImageWriter = new javax.swing.JCheckBox();
        jScrollPane1 = new javax.swing.JScrollPane();
        rulesTable = new javax.swing.JTable();
        folderNamesLabel = new javax.swing.JLabel();
        fileSizeLabel = new javax.swing.JLabel();
        jSeparator1 = new javax.swing.JSeparator();
        minSizeLabel = new javax.swing.JLabel();
        minSizeTextField = new javax.swing.JFormattedTextField();
        maxSizeLabel = new javax.swing.JLabel();
        maxSizeTextField = new javax.swing.JFormattedTextField();

        org.openide.awt.Mnemonics.setLocalizedText(modifiedDateLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.modifiedDateLabel.text")); // NOI18N

        daysIncludedTextField.setEditable(false);
        daysIncludedTextField.setHorizontalAlignment(javax.swing.JTextField.TRAILING);
        daysIncludedTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.daysIncludedTextField.text")); // NOI18N
        daysIncludedTextField.setEnabled(false);
        daysIncludedTextField.setMinimumSize(new java.awt.Dimension(60, 20));
        daysIncludedTextField.setPreferredSize(new java.awt.Dimension(60, 20));

        org.openide.awt.Mnemonics.setLocalizedText(daysIncludedLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.daysIncludedLabel.text")); // NOI18N
        daysIncludedLabel.setEnabled(false);

        org.openide.awt.Mnemonics.setLocalizedText(fullPathsLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.fullPathsLabel.text")); // NOI18N

        org.openide.awt.Mnemonics.setLocalizedText(flagEncryptionProgramsCheckBox, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.flagEncryptionProgramsCheckBox.text")); // NOI18N
        flagEncryptionProgramsCheckBox.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                flagEncryptionProgramsCheckBoxActionPerformed(evt);
            }
        });

        org.openide.awt.Mnemonics.setLocalizedText(ruleNameLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.ruleNameLabel.text")); // NOI18N

        ruleNameEditTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.ruleNameEditTextField.text")); // NOI18N
        ruleNameEditTextField.setEnabled(false);

        newRuleButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/org/sleuthkit/autopsy/images/add16.png"))); // NOI18N
        org.openide.awt.Mnemonics.setLocalizedText(newRuleButton, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.newRuleButton.text")); // NOI18N
        newRuleButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                newRuleButtonActionPerformed(evt);
            }
        });

        org.openide.awt.Mnemonics.setLocalizedText(descriptionLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.descriptionLabel.text")); // NOI18N

        editRuleButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/org/sleuthkit/autopsy/images/edit16.png"))); // NOI18N
        org.openide.awt.Mnemonics.setLocalizedText(editRuleButton, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.editRuleButton.text")); // NOI18N
        editRuleButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                editRuleButtonActionPerformed(evt);
            }
        });

        descriptionEditTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.descriptionEditTextField.text")); // NOI18N
        descriptionEditTextField.setEnabled(false);

        deleteRuleButton.setIcon(new javax.swing.ImageIcon(getClass().getResource("/org/sleuthkit/autopsy/images/delete16.png"))); // NOI18N
        org.openide.awt.Mnemonics.setLocalizedText(deleteRuleButton, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.deleteRuleButton.text")); // NOI18N
        deleteRuleButton.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                deleteRuleButtonActionPerformed(evt);
            }
        });

        fullPathsTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                ""
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        fullPathsTable.setColumnSelectionAllowed(true);
        fullPathsTable.setEnabled(false);
        fullPathsTable.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        fullPathsTable.setShowHorizontalLines(false);
        fullPathsTable.setShowVerticalLines(false);
        fullPathsTable.getTableHeader().setReorderingAllowed(false);
        jScrollPane5.setViewportView(fullPathsTable);
        fullPathsTable.getColumnModel().getSelectionModel().setSelectionMode(javax.swing.ListSelectionModel.SINGLE_INTERVAL_SELECTION);
        if (fullPathsTable.getColumnModel().getColumnCount() > 0) {
            fullPathsTable.getColumnModel().getColumn(0).setHeaderValue(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.fullPathsTable.columnModel.title0")); // NOI18N
        }

        filenamesTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                ""
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        filenamesTable.setEnabled(false);
        filenamesTable.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        filenamesTable.setShowHorizontalLines(false);
        filenamesTable.setShowVerticalLines(false);
        filenamesTable.getTableHeader().setReorderingAllowed(false);
        jScrollPane6.setViewportView(filenamesTable);
        if (filenamesTable.getColumnModel().getColumnCount() > 0) {
            filenamesTable.getColumnModel().getColumn(0).setHeaderValue(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.filenamesTable.columnModel.title0")); // NOI18N
        }

        shouldSaveCheckBox.setSelected(true);
        org.openide.awt.Mnemonics.setLocalizedText(shouldSaveCheckBox, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.shouldSaveCheckBox.text")); // NOI18N
        shouldSaveCheckBox.setToolTipText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.shouldSaveCheckBox.toolTipText")); // NOI18N
        shouldSaveCheckBox.setEnabled(false);

        shouldAlertCheckBox.setSelected(true);
        org.openide.awt.Mnemonics.setLocalizedText(shouldAlertCheckBox, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.shouldAlertCheckBox.text")); // NOI18N
        shouldAlertCheckBox.setEnabled(false);

        folderNamesTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                ""
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }
        });
        folderNamesTable.setEnabled(false);
        folderNamesTable.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        folderNamesTable.setShowHorizontalLines(false);
        folderNamesTable.setShowVerticalLines(false);
        folderNamesTable.getTableHeader().setReorderingAllowed(false);
        jScrollPane7.setViewportView(folderNamesTable);
        if (folderNamesTable.getColumnModel().getColumnCount() > 0) {
            folderNamesTable.getColumnModel().getColumn(0).setHeaderValue(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.folderNamesTable.columnModel.title0")); // NOI18N
        }

        org.openide.awt.Mnemonics.setLocalizedText(extensionsLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.extensionsLabel.text")); // NOI18N

        extensionsTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.extensionsTextField.text")); // NOI18N
        extensionsTextField.setEnabled(false);

        org.openide.awt.Mnemonics.setLocalizedText(filenamesLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.filenamesLabel.text")); // NOI18N

        configFileTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.configFileTextField.text")); // NOI18N
        configFileTextField.setToolTipText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.configFileTextField.toolTipText")); // NOI18N
        configFileTextField.setEnabled(false);

        org.openide.awt.Mnemonics.setLocalizedText(ruleSetFileLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.ruleSetFileLabel.text")); // NOI18N

        org.openide.awt.Mnemonics.setLocalizedText(finalizeImageWriter, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.finalizeImageWriter.text")); // NOI18N
        finalizeImageWriter.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                finalizeImageWriterActionPerformed(evt);
            }
        });

        rulesTable.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "Rule Name", "Description"
            }
        ) {
            Class[] types = new Class [] {
                java.lang.String.class, java.lang.String.class
            };
            boolean[] canEdit = new boolean [] {
                false, false
            };

            public Class getColumnClass(int columnIndex) {
                return types [columnIndex];
            }

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        rulesTable.setAutoResizeMode(javax.swing.JTable.AUTO_RESIZE_ALL_COLUMNS);
        rulesTable.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        rulesTable.setShowHorizontalLines(false);
        rulesTable.setShowVerticalLines(false);
        rulesTable.getTableHeader().setReorderingAllowed(false);
        rulesTable.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseReleased(java.awt.event.MouseEvent evt) {
                rulesTableMouseReleased(evt);
            }
        });
        rulesTable.addKeyListener(new java.awt.event.KeyAdapter() {
            public void keyReleased(java.awt.event.KeyEvent evt) {
                rulesTableKeyReleased(evt);
            }
        });
        jScrollPane1.setViewportView(rulesTable);
        if (rulesTable.getColumnModel().getColumnCount() > 0) {
            rulesTable.getColumnModel().getColumn(0).setHeaderValue(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.rulesTable.columnModel.title0")); // NOI18N
            rulesTable.getColumnModel().getColumn(1).setHeaderValue(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.rulesTable.columnModel.title1")); // NOI18N
        }

        org.openide.awt.Mnemonics.setLocalizedText(folderNamesLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.folderNamesLabel.text")); // NOI18N

        org.openide.awt.Mnemonics.setLocalizedText(fileSizeLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.fileSizeLabel.text")); // NOI18N

        org.openide.awt.Mnemonics.setLocalizedText(minSizeLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.minSizeLabel.text")); // NOI18N

        minSizeTextField.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,###; "))));
        minSizeTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.minSizeTextField.text")); // NOI18N
        minSizeTextField.setEnabled(false);

        org.openide.awt.Mnemonics.setLocalizedText(maxSizeLabel, org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.maxSizeLabel.text")); // NOI18N

        maxSizeTextField.setFormatterFactory(new javax.swing.text.DefaultFormatterFactory(new javax.swing.text.NumberFormatter(new java.text.DecimalFormat("#,###; "))));
        maxSizeTextField.setText(org.openide.util.NbBundle.getMessage(ConfigVisualPanel2.class, "ConfigVisualPanel2.maxSizeTextField.text")); // NOI18N
        maxSizeTextField.setEnabled(false);

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(480, 480, 480)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(daysIncludedTextField, javax.swing.GroupLayout.PREFERRED_SIZE, 54, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(daysIncludedLabel))
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(ruleNameEditTextField, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(descriptionEditTextField, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(extensionsTextField, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane5, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane6, javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane7, javax.swing.GroupLayout.Alignment.LEADING))
                        .addContainerGap())))
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 377, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(newRuleButton)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                .addComponent(editRuleButton)
                                .addGap(37, 37, 37)
                                .addComponent(deleteRuleButton)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(flagEncryptionProgramsCheckBox)
                            .addComponent(finalizeImageWriter)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(393, 393, 393)
                        .addComponent(shouldSaveCheckBox))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(397, 397, 397)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(extensionsLabel)
                            .addComponent(filenamesLabel)
                            .addComponent(descriptionLabel)
                            .addComponent(ruleNameLabel)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(397, 397, 397)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(modifiedDateLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 79, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(fileSizeLabel)
                            .addComponent(fullPathsLabel)
                            .addComponent(folderNamesLabel))
                        .addGap(4, 4, 4)
                        .addComponent(minSizeLabel)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(minSizeTextField, javax.swing.GroupLayout.PREFERRED_SIZE, 63, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(18, 18, 18)
                        .addComponent(maxSizeLabel)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(maxSizeTextField, javax.swing.GroupLayout.PREFERRED_SIZE, 63, javax.swing.GroupLayout.PREFERRED_SIZE))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(393, 393, 393)
                        .addComponent(shouldAlertCheckBox)))
                .addContainerGap())
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(17, 17, 17)
                        .addComponent(ruleSetFileLabel)
                        .addGap(18, 18, 18)
                        .addComponent(configFileTextField))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(397, 397, 397)
                        .addComponent(jSeparator1)))
                .addGap(10, 10, 10))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(configFileTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(ruleSetFileLabel))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 527, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(newRuleButton)
                            .addComponent(editRuleButton)
                            .addComponent(deleteRuleButton)))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGap(30, 30, 30)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                    .addComponent(descriptionEditTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(descriptionLabel))
                                .addGap(9, 9, 9)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                    .addComponent(extensionsTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                    .addComponent(extensionsLabel)))
                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                                .addComponent(ruleNameEditTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addComponent(ruleNameLabel)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane6, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(filenamesLabel)
                                .addGap(0, 0, Short.MAX_VALUE)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jScrollPane7, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(folderNamesLabel)
                                .addGap(0, 0, Short.MAX_VALUE)))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(fullPathsLabel)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                                .addComponent(jScrollPane5, javax.swing.GroupLayout.PREFERRED_SIZE, 0, Short.MAX_VALUE)
                                .addGap(11, 11, 11)))
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                            .addComponent(minSizeLabel)
                            .addComponent(minSizeTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(maxSizeLabel)
                            .addComponent(maxSizeTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(fileSizeLabel))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.CENTER)
                            .addComponent(modifiedDateLabel)
                            .addComponent(daysIncludedTextField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(daysIncludedLabel))
                        .addGap(3, 3, 3)
                        .addComponent(shouldAlertCheckBox)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(shouldSaveCheckBox)
                        .addGap(18, 18, 18)
                        .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, 2, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(flagEncryptionProgramsCheckBox)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(finalizeImageWriter)))
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    private void finalizeImageWriterActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_finalizeImageWriterActionPerformed
        config.setFinalizeImageWriter(finalizeImageWriter.isSelected());
    }//GEN-LAST:event_finalizeImageWriterActionPerformed

    private void rulesTableKeyReleased(java.awt.event.KeyEvent evt) {//GEN-FIRST:event_rulesTableKeyReleased
        rulesTableSelect();
    }//GEN-LAST:event_rulesTableKeyReleased

    @NbBundle.Messages({
        "ConfigVisualPanel2.editRuleSet=Edit rule",
        "ConfigVisualPanel2.editRuleError=Edit rule error"
    })
    private void editRuleButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_editRuleButtonActionPerformed
        int row = rulesTable.getSelectedRow();
        if (row != -1) {
            String ruleName = (String) rulesTable.getModel().getValueAt(row, 0);
            LogicalImagerRule rule = getFirstRuleSet().getRules().get(row);
            EditRulePanel editPanel = new EditRulePanel(okButton, cancelButton, ruleName, rule);
            editPanel.setEnabled(true);
            editPanel.setVisible(true);

            while (true) {
                int option = JOptionPane.showOptionDialog(this, editPanel.getPanel(), Bundle.ConfigVisualPanel2_editRuleSet(), 
                            JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE, 
                            null, new Object[]{okButton, cancelButton}, okButton);
                if (option == JOptionPane.OK_OPTION) {
                    try {
                        ImmutablePair<String, LogicalImagerRule> ruleMap = editPanel.toRule();
                        appendRow(ruleMap);
                        break;
                    } catch (Exception ex) {
                        JOptionPane.showMessageDialog(this,
                            ex.getMessage(),
                            Bundle.ConfigVisualPanel2_editRuleError(),
                            JOptionPane.ERROR_MESSAGE);
                        // let user fix the error
                    }
                } else {
                    break;
                }
            }
        }   
    }//GEN-LAST:event_editRuleButtonActionPerformed

    private void newRuleButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_newRuleButtonActionPerformed
        NewRuleSetPanel panel;
        panel = new NewRuleSetPanel(okButton, cancelButton);
        panel.setEnabled(true);
        panel.setVisible(true);

        while (true) {
            int option = JOptionPane.showOptionDialog(this, panel, "New rule", 
                        JOptionPane.OK_CANCEL_OPTION, JOptionPane.PLAIN_MESSAGE, 
                        null, new Object[]{okButton, cancelButton}, okButton);
            if (option == JOptionPane.OK_OPTION) {
                try {
                    // Save the new rule
                    ImmutablePair<String, LogicalImagerRule> ruleMap = panel.toRule();
                    appendRow(ruleMap);
                    break;
                } catch (Exception ex) {
                    JOptionPane.showMessageDialog(this,
                        ex.getMessage(),
                        "New rule error",
                        JOptionPane.ERROR_MESSAGE);
                    // let user fix the error
                }
            } else {
                break;
            }
        }        
    }//GEN-LAST:event_newRuleButtonActionPerformed

    @NbBundle.Messages({
        "ConfigVisualPanel2.deleteRuleSet=Delete rule ",
        "ConfigVisualPanel2.deleteRuleSetConfirmation=Delete rule confirmation",
    })
    private void deleteRuleButtonActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_deleteRuleButtonActionPerformed
        int index = rulesTable.getSelectedRow();
        if (index != -1) {
            String ruleName = (String) rulesTable.getModel().getValueAt(index, 0);

            int option = JOptionPane.showOptionDialog(this, 
                    Bundle.ConfigVisualPanel2_deleteRuleSet() + ruleName, 
                    Bundle.ConfigVisualPanel2_deleteRuleSetConfirmation(), 
                JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE, null, null, null);
            if (option == JOptionPane.NO_OPTION) {
                return;
            }

            getFirstRuleSet().getRules().remove(index);
            updatePanel(configFilename, config);
            if (rulesTable.getRowCount() > 0) {
                rulesTable.setRowSelectionInterval(0, 0);
                rulesTableSelect();
            }
        }
    }//GEN-LAST:event_deleteRuleButtonActionPerformed

    private void flagEncryptionProgramsCheckBoxActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_flagEncryptionProgramsCheckBoxActionPerformed
        flagEncryptionPrograms = flagEncryptionProgramsCheckBox.isSelected();
        toggleEncryptionProgramsRule(flagEncryptionPrograms);
    }//GEN-LAST:event_flagEncryptionProgramsCheckBoxActionPerformed

    private void rulesTableMouseReleased(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_rulesTableMouseReleased
        rulesTableSelect();
    }//GEN-LAST:event_rulesTableMouseReleased

    private void toggleEncryptionProgramsRule(boolean flagEncryptionPrograms) {
        if (flagEncryptionPrograms) {
            // add the special rule
            ImmutablePair<String, LogicalImagerRule> ruleMap = createEncryptionProgramsRule();
            appendRow(ruleMap);            
        } else {
            // remove it
            int index = ((RulesTableModel) rulesTable.getModel()).findRow(EncryptionProgramsRule.getName());
            if (index != -1) {
                getFirstRuleSet().getRules().remove(index);
                updatePanel(configFilename, config);
                if (rulesTable.getRowCount() > 0) {
                    rulesTable.setRowSelectionInterval(0, 0);
                    rulesTableSelect();
                }
            }
        }
    }
    
    /*
     * Create an encryption programs rule
     */
    private ImmutablePair<String, LogicalImagerRule> createEncryptionProgramsRule() {
        LogicalImagerRule.Builder builder = new LogicalImagerRule.Builder();
        builder.name(EncryptionProgramsRule.getName())
                .description(EncryptionProgramsRule.getDescription())
                .shouldAlert(true)
                .shouldSave(true)
                .filenames(EncryptionProgramsRule.getFilenames());
        LogicalImagerRule rule = builder.build();
        return new ImmutablePair<>(EncryptionProgramsRule.getName(), rule);
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JTextField configFileTextField;
    private javax.swing.JLabel daysIncludedLabel;
    private javax.swing.JTextField daysIncludedTextField;
    private javax.swing.JButton deleteRuleButton;
    private javax.swing.JTextField descriptionEditTextField;
    private javax.swing.JLabel descriptionLabel;
    private javax.swing.JButton editRuleButton;
    private javax.swing.JLabel extensionsLabel;
    private javax.swing.JTextField extensionsTextField;
    private javax.swing.JLabel fileSizeLabel;
    private javax.swing.JLabel filenamesLabel;
    private javax.swing.JTable filenamesTable;
    private javax.swing.JCheckBox finalizeImageWriter;
    private javax.swing.JCheckBox flagEncryptionProgramsCheckBox;
    private javax.swing.JLabel folderNamesLabel;
    private javax.swing.JTable folderNamesTable;
    private javax.swing.JLabel fullPathsLabel;
    private javax.swing.JTable fullPathsTable;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JScrollPane jScrollPane5;
    private javax.swing.JScrollPane jScrollPane6;
    private javax.swing.JScrollPane jScrollPane7;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JLabel maxSizeLabel;
    private javax.swing.JFormattedTextField maxSizeTextField;
    private javax.swing.JLabel minSizeLabel;
    private javax.swing.JFormattedTextField minSizeTextField;
    private javax.swing.JLabel modifiedDateLabel;
    private javax.swing.JButton newRuleButton;
    private javax.swing.JTextField ruleNameEditTextField;
    private javax.swing.JLabel ruleNameLabel;
    private javax.swing.JLabel ruleSetFileLabel;
    private javax.swing.JTable rulesTable;
    private javax.swing.JCheckBox shouldAlertCheckBox;
    private javax.swing.JCheckBox shouldSaveCheckBox;
    // End of variables declaration//GEN-END:variables

    private LogicalImagerRuleSet getFirstRuleSet() {
        if (config.getRuleSets().isEmpty()) {
            List<LogicalImagerRuleSet> ruleSets = new ArrayList<>();
            ruleSets.add(new LogicalImagerRuleSet("no-set-name", new ArrayList<>())); // NON-NLS
            config.setRuleSet(ruleSets);
        }
        return config.getRuleSets().get(0);
    }
    
    private void updatePanel(String configFilePath, LogicalImagerConfig config, String rowSelectionkey) {
        configFileTextField.setText(configFilePath);
        finalizeImageWriter.setSelected(config.isFinalizeImageWriter());
        LogicalImagerRuleSet ruleSet = getFirstRuleSet();
        flagEncryptionProgramsCheckBox.setSelected(ruleSet.find(EncryptionProgramsRule.getName()) != null);
        RulesTableModel rulesTableModel = new RulesTableModel();
        int row = 0;
        int selectThisRow = 0;

        Collections.sort(ruleSet.getRules(), new SortRuleByName());
        
        for (LogicalImagerRule rule : ruleSet.getRules()) {
            rulesTableModel.setValueAt(rule.getName(), row, 0);
            if (rowSelectionkey != null && rule.getName().equals(rowSelectionkey)) {
                selectThisRow = row;
            }
            rulesTableModel.setValueAt(rule.getDescription(), row, 1);
            rulesTableModel.setValueAt(rule, row, 2);
            row++;
        }
        rulesTable.setAutoResizeMode(JTable.AUTO_RESIZE_LAST_COLUMN);
        rulesTable.setModel(rulesTableModel);
        // If there are any rules, select the first one
        if (rulesTableModel.getRowCount() > 0) {
            rulesTable.setRowSelectionInterval(selectThisRow, selectThisRow);
            rulesTableSelect();
        } else {
            updateRuleSetButtons(false);
        }
    }
    
    private void updatePanel(String configFilePath, LogicalImagerConfig config) {
        updatePanel(configFilePath, config, null);
    }

    private void rulesTableSelect() {
        int index = rulesTable.getSelectedRow();
        if (index != -1) {
            String ruleName = (String) rulesTable.getModel().getValueAt(index, 0);
            String description = (String) rulesTable.getModel().getValueAt(index, 1);
            updateRuleDetails(ruleName, description, config);
            updateRuleSetButtons(ruleName.equals(EncryptionProgramsRule.getName()) ? false : true);
        } else {
            updateRuleSetButtons(false);            
        }
    }

    private void updateRuleDetails(String ruleName, String description, LogicalImagerConfig config) {
        clearRuleDetails();
        LogicalImagerRule rule = getFirstRuleSet().find(ruleName);
        shouldAlertCheckBox.setSelected(rule.isShouldAlert());
        shouldSaveCheckBox.setSelected(rule.isShouldSave());
        ruleNameEditTextField.setText(ruleName);
        descriptionEditTextField.setText(description);
        updateExtensions(rule.getExtensions());
        updateList(filenamesTable, rule.getFilenames());
        updateList(folderNamesTable, rule.getPaths());
        updateList(fullPathsTable, rule.getFullPaths());
        if (rule.getMinFileSize() == null) {
            minSizeTextField.setText("");
        } else {
            minSizeTextField.setText(rule.getMinFileSize().toString());
        }
        if (rule.getMaxFileSize() == null) {
            maxSizeTextField.setText("");
        } else {
            maxSizeTextField.setText(rule.getMaxFileSize().toString());
        }
        if (rule.getMinDays() == null) {
            daysIncludedTextField.setText("");
        } else {
            daysIncludedTextField.setText(Integer.toString(rule.getMinDays()));
        }
    }

    private void clearRuleDetails() {
        extensionsTextField.setText("");
        shouldAlertCheckBox.setSelected(false);
        shouldSaveCheckBox.setSelected(true);
    }

    private void updateExtensions(List<String> extensions) {
        extensionsTextField.setText("");
        if (extensions == null) {
            return;
        }
        String content = "";
        boolean first = true;
        for (String ext : extensions) {            
            content += (first ? "" : ",") + ext;
            first = false;
        }
        extensionsTextField.setText(content);
    }

    private void updateList(javax.swing.JTable jTable, List<String> set) {
        SingleColumnTableModel tableModel = new SingleColumnTableModel();
        jTable.setTableHeader(null);
        if (set == null) {
            jTable.setModel(tableModel);
            return;
        }
        int row = 0;
        for (String s : set) {
            tableModel.setValueAt(s, row, 0);
            row++;
        }
        jTable.setModel(tableModel);
    }

    void setConfiguration(String configFilename, LogicalImagerConfig config, boolean newFile) {
        this.configFilename = configFilename;
        this.config = config;
        if (newFile) {
            initPanel();
        }
        updatePanel(configFilename, config);
    }

    private void initPanel() {
        configFileTextField.setText("");
        rulesTable.setModel(new RulesTableModel());
        shouldAlertCheckBox.setSelected(false);
        shouldSaveCheckBox.setSelected(true);
        ruleNameEditTextField.setText("");
        descriptionEditTextField.setText("");
        extensionsTextField.setText("");
        updateList(filenamesTable, EMPTY_LIST);
        updateList(folderNamesTable, EMPTY_LIST);
    }

    boolean isPanelValid() {
        return true;
    }

    private void appendRow(ImmutablePair<String, LogicalImagerRule> ruleMap) {
        getFirstRuleSet().getRules().add(ruleMap.getValue());
        updatePanel(configFilename, config, ruleMap.getKey());
    }

    private void updateRuleSetButtons(boolean isRowSelected) {
        newRuleButton.setEnabled(true);
        editRuleButton.setEnabled(isRowSelected);
        deleteRuleButton.setEnabled(isRowSelected);
    }

    /**
     * Sort rule by name
     */
    private class SortRuleByName implements Comparator<LogicalImagerRule> {

        public int compare(LogicalImagerRule a, LogicalImagerRule b) {
            return a.getName().compareToIgnoreCase(b.getName());
        }
    }

    private class RulesTableModel extends AbstractTableModel {

        private final List<String> ruleName = new ArrayList<>();
        private final List<String> ruleDescription = new ArrayList<>();
        private final List<LogicalImagerRule> rule = new ArrayList<>();

        public int findRow(String name) {
            return ruleName.indexOf(name);
        }
        
        @Override
        public int getRowCount() {
            return ruleName.size();
        }

        @Override
        public int getColumnCount() {
            return 2;
        }

        @NbBundle.Messages({
            "ConfigVisualPanel2.rulesTable.columnModel.title0=Rule Name",
            "ConfigVisualPanel2.rulesTable.columnModel.title1=Description"
        })
        @Override
        public String getColumnName(int column) {
            String colName = null;
            switch (column) {
                case 0:
                    colName = Bundle.ConfigVisualPanel2_rulesTable_columnModel_title0();
                    break;
                case 1:
                    colName = Bundle.ConfigVisualPanel2_rulesTable_columnModel_title1();
                    break;
                default:
                    break;
            }
            return colName;
        }

        @Override
        public Object getValueAt(int rowIndex, int columnIndex) {
            Object ret = null;
            switch (columnIndex) {
                case 0:
                    ret = ruleName.get(rowIndex);
                    break;
                case 1:
                    ret = ruleDescription.get(rowIndex);
                    break;
                case 2:
                    ret = rule.get(rowIndex);
                    break;
                default:
                    throw new UnsupportedOperationException("Invalid table column index: " + columnIndex); //NON-NLS
            }
            return ret;
        }

        @Override
        public boolean isCellEditable(int rowIndex, int columnIndex) {
            return false;
        }

        @Override
        public void setValueAt(Object aValue, int rowIndex, int columnIndex) {
            switch (columnIndex) {
                case 0:
                    ruleName.add((String) aValue);
                    break;
                case 1:
                    ruleDescription.add((String) aValue);
                    break;
                case 2:
                    rule.add((LogicalImagerRule) aValue);
                    break;
                default:
                    throw new UnsupportedOperationException("Invalid table column index: " + columnIndex); //NON-NLS
            }
            // Only show the name and description column
            if (columnIndex < 2) {
                super.setValueAt(aValue, rowIndex, columnIndex);
            }
        }
    }

    private class SingleColumnTableModel extends AbstractTableModel {

        private final List<String> list = new ArrayList<>();

        @Override
        public int getRowCount() {
            return list.size();
        }

        @Override
        public int getColumnCount() {
            return 1;
        }

        @Override
        public String getColumnName(int column) {
            return "";
        }

        @Override
        public Object getValueAt(int rowIndex, int columnIndex) {
            Object ret = null;
            switch (columnIndex) {
                case 0:
                    ret = list.get(rowIndex);
                    break;
                default:
                    throw new UnsupportedOperationException("Invalid table column index: " + columnIndex); //NON-NLS
            }
            return ret;
        }

        @Override
        public boolean isCellEditable(int rowIndex, int columnIndex) {
            return true;
        }

        @Override
        public void setValueAt(Object aValue, int rowIndex, int columnIndex) {
            switch (columnIndex) {
                case 0:
                    list.add((String) aValue);
                    break;
                default:
                    throw new UnsupportedOperationException("Invalid table column index: " + columnIndex); //NON-NLS
            }
        }
    }
}
